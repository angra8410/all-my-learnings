<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Introducci√≥n a Data Visualization - DataViz-Storytelling</title>

    <!-- styles: usamos CDN para que funcione en htmlpreview/jsDelivr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/angra8410/all-my-learnings@main/DataViz-Storytelling/examples/styles.css">

    <!-- Chart & Plotly CDN (ya incluidos; verifica en Network que carguen 200) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js"></script>

    <style>
      .chart-container{ position: relative; height: 420px; margin-bottom: 12px; }
      .chart-canvas{ width:100% !important; height:100% !important; display:block; }
      .hidden{ display:none; }
      #fallback-toast { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
      .file-upload-area.dragover { outline: 3px dashed rgba(102,126,234,0.6); background: rgba(102,126,234,0.03); }
    </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä M√≥dulo 01: Introducci√≥n a Data Visualization</h1>
      <p>Ejercicio Interactivo - DataViz-Storytelling</p>
    </div>

    <div class="content">
      <div class="alert alert-info">
        <strong>Instrucciones:</strong> Carga un CSV, configura el gr√°fico y responde el cuestionario.
      </div>

      <!-- Paso 1: Cargar datos -->
      <div class="section">
        <h2>üìÅ Paso 1: Cargar Datos</h2>
        <div class="form-group">
          <label>Cargar archivo CSV:</label>
          <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" style="border:2px dashed #9aa;padding:24px;text-align:center;cursor:pointer;">
            <input type="file" id="fileInput" accept=".csv" onchange="loadCSV(event)">
            <p>üìÇ Click aqu√≠ para seleccionar un archivo CSV</p>
            <p style="font-size: 0.9em; opacity: 0.7;">O usa los archivos de ejemplo en /examples/</p>
          </div>
        </div>
        <div class="form-group">
          <label>O pega datos CSV:</label>
          <textarea id="csvTextInput" placeholder="Mes,Producto,Ventas&#10;Enero,A,150&#10;Febrero,A,180" rows="6" style="width:100%"></textarea>
          <button class="btn btn-secondary" onclick="parseManualCSV()">Cargar datos pegados</button>
        </div>

        <div id="dataPreview" class="hidden">
          <h3>Vista previa de datos:</h3>
          <div style="overflow-x: auto;">
            <table class="data-table" id="dataTable"></table>
          </div>
          <p><strong>Filas cargadas:</strong> <span id="rowCount">0</span></p>
        </div>
      </div>

      <!-- Paso 2: Configurar gr√°fico -->
      <div class="section">
        <h2>‚öôÔ∏è Paso 2: Configurar Gr√°fico</h2>
        <div class="form-group">
          <label for="chartType">Tipo de gr√°fico:</label>
          <select id="chartType">
            <option value="bar">Barras</option>
            <option value="line">L√≠neas</option>
            <option value="scatter">Dispersi√≥n (Scatter)</option>
            <option value="pie">Circular (Pie)</option>
            <option value="doughnut">Dona (Doughnut)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="xAxis">Eje X (etiquetas):</label>
          <select id="xAxis"><option value="">Selecciona columna...</option></select>
        </div>
        <div class="form-group">
          <label for="yAxis">Eje Y (valores):</label>
          <select id="yAxis"><option value="">Selecciona columna...</option></select>
        </div>
        <div class="form-group">
          <label for="groupBy">Agrupar por (opcional):</label>
          <select id="groupBy"><option value="">Sin agrupaci√≥n</option></select>
        </div>
        <div class="form-group">
          <label for="aggregation">Operaci√≥n de agregaci√≥n:</label>
          <select id="aggregation">
            <option value="sum">Suma</option><option value="avg">Promedio</option>
            <option value="count">Conteo</option><option value="max">M√°ximo</option>
            <option value="min">M√≠nimo</option>
          </select>
        </div>
        <div class="form-group">
          <label for="chartTitle">T√≠tulo del gr√°fico:</label>
          <input type="text" id="chartTitle" placeholder="Mi Gr√°fico de Datos">
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="renderChart()">Generar Gr√°fico</button>
          <button class="btn btn-secondary" onclick="clearChart()">Limpiar</button>
        </div>
      </div>

      <!-- Paso 3: Visualizaci√≥n -->
      <div class="section">
        <h2>üìä Paso 3: Visualizaci√≥n</h2>
        <div class="chart-container">
          <canvas id="myChart" class="chart-canvas"></canvas>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="downloadChart()">Descargar Gr√°fico PNG</button>
          <button class="btn btn-secondary" onclick="downloadProcessedData()">Descargar Datos Procesados CSV</button>
        </div>
      </div>

      <!-- Paso 4: Cuestionario -->
      <div class="section">
        <h2>‚úÖ Paso 4: Cuestionario del M√≥dulo</h2>
        <form id="quizForm">
          <div class="quiz-question">
            <div class="question-number">Pregunta 1 de 4</div>
            <div class="question-text">¬øCu√°l es el prop√≥sito principal de la visualizaci√≥n de datos?</div>
            <div class="quiz-options">
              <div class="quiz-option"><input type="radio" name="q1" value="a" id="q1a"><label for="q1a">Decorar informes</label></div>
              <div class="quiz-option"><input type="radio" name="q1" value="b" id="q1b"><label for="q1b">Comunicar informaci√≥n de forma efectiva</label></div>
              <div class="quiz-option"><input type="radio" name="q1" value="c" id="q1c"><label for="q1c">Ocultar datos complejos</label></div>
            </div>
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="evaluateQuiz()">Evaluar</button>
            <button type="button" class="btn btn-secondary" onclick="resetQuiz()">Reiniciar</button>
          </div>
        </form>

        <div id="quizResults" class="results hidden">
          <h3>Resultados del Cuestionario</h3>
          <div class="score" id="quizScore">0%</div>
          <p id="quizFeedback"></p>
        </div>
      </div>

      <!-- Paso 5: Guardar y exportar -->
      <div class="section">
        <h2>üíæ Paso 5: Guardar y Exportar</h2>
        <div class="btn-group">
          <button class="btn btn-success" onclick="downloadAllResults()">Descargar Todos los Resultados JSON</button>
          <button class="btn btn-secondary" onclick="clearSavedData()">Limpiar Datos Guardados</button>
        </div>
        <div id="savedDataInfo" class="card">
          <div class="card-header">Informaci√≥n de Guardado</div>
          <div class="card-body" id="savedDataContent">No hay datos guardados a√∫n.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- utils.js desde jsDelivr (apunta a tu repo/branch) -->
  <script src="https://cdn.jsdelivr.net/gh/angra8410/all-my-learnings@main/DataViz-Storytelling/examples/utils.js"></script>

  <!-- Fallbacks m√≠nimos + groupBy/aggregate seguros -->
  <script>
  (function(){
    // parseCSV fallback
    if (typeof parseCSV !== 'function') {
      window.parseCSV = function(text) {
        if (!text) return [];
        const sample = String(text).slice(0, 2000);
        const counts = { ',': (sample.match(/,/g) || []).length, ';': (sample.match(/;/g) || []).length, '\t': (sample.match(/\t/g) || []).length };
        let delim = ',';
        if (counts[';'] > counts[','] && counts[';'] >= counts['\t']) delim = ';';
        else if (counts['\t'] > counts[','] && counts['\t'] >= counts[';']) delim = '\t';
        const lines = String(text).trim().split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length === 0) return [];
        const headers = lines.shift().split(delim).map(h => h.trim());
        return lines.map(l => {
          const cols = l.split(delim);
          const obj = {};
          for (let i = 0; i < headers.length; i++) obj[headers[i]] = (cols[i] || '').trim();
          return obj;
        });
      };
      console.info('[fallbacks] parseCSV fallback installed');
    }

    // showNotification fallback
    if (typeof showNotification !== 'function') {
      window.showNotification = function(message, type) {
        console.log('[showNotification]', type || 'info', message);
        try {
          const id = 'fallback-toast';
          let toast = document.getElementById(id);
          if (!toast) {
            toast = document.createElement('div');
            toast.id = id;
            toast.style.position = 'fixed';
            toast.style.right = '16px';
            toast.style.top = '16px';
            toast.style.zIndex = 99999;
            toast.style.maxWidth = '320px';
            document.body.appendChild(toast);
          }
          const item = document.createElement('div');
          item.textContent = message;
          item.style.margin = '6px';
          item.style.padding = '8px 12px';
          item.style.borderRadius = '6px';
          item.style.color = '#fff';
          item.style.fontSize = '13px';
          item.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
          if (type === 'success') item.style.background = '#28a745';
          else if (type === 'error') item.style.background = '#dc3545';
          else if (type === 'warning') { item.style.background = '#ffc107'; item.style.color = '#000'; }
          else item.style.background = '#17a2b8';
          toast.appendChild(item);
          setTimeout(() => { try { item.remove(); } catch(e){} }, 4000);
        } catch (e) {}
      };
      console.info('[fallbacks] showNotification fallback installed');
    }

    // LocalStorage wrappers
    if (typeof loadFromLocalStorage !== 'function') {
      window.loadFromLocalStorage = function(key) {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; } catch(e) { return null; }
      };
      console.info('[fallbacks] loadFromLocalStorage fallback installed');
    }
    if (typeof saveToLocalStorage !== 'function') {
      window.saveToLocalStorage = function(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch(e) { return false; }
      };
      console.info('[fallbacks] saveToLocalStorage fallback installed');
    }

    // arrayToCSV & downloadFile fallbacks
    if (typeof arrayToCSV !== 'function') {
      window.arrayToCSV = function(arr) {
        if (!Array.isArray(arr) || arr.length === 0) return '';
        const headers = Object.keys(arr[0]);
        const lines = [headers.join(',')];
        arr.forEach(row => {
          const cols = headers.map(h => {
            let v = row[h] === null || row[h] === undefined ? '' : String(row[h]);
            if (v.includes('"')) v = v.replace(/"/g, '""');
            if (/[,"\n]/.test(v)) v = `"${v}"`;
            return v;
          });
          lines.push(cols.join(','));
        });
        return lines.join('\r\n');
      };
      console.info('[fallbacks] arrayToCSV fallback installed');
    }
    if (typeof downloadFile !== 'function') {
      window.downloadFile = function(content, filename, mime='text/plain') {
        try {
          const blob = new Blob([content], { type: mime });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename || 'download';
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        } catch (e) { console.error('[fallbacks] downloadFile error', e); }
      };
      console.info('[fallbacks] downloadFile fallback installed');
    }

    // groupBy fallback - assign to safe name __groupBy (to avoid DOM id collision)
    if (typeof window.__groupBy !== 'function') {
      window.__groupBy = function(arr, key) {
        const result = {};
        if (!Array.isArray(arr)) return result;
        for (const item of arr) {
          const k = (item && Object.prototype.hasOwnProperty.call(item, key)) ? item[key] : '__undefined__';
          const sk = (k === null || k === undefined) ? '__null__' : String(k);
          if (!result[sk]) result[sk] = [];
          result[sk].push(item);
        }
        console.info('[fallbacks] __groupBy fallback installed');
        return result;
      };
    }

    // aggregate fallback - assign to safe name __aggregate
    if (typeof window.__aggregate !== 'function') {
      window.__aggregate = function(items, xCol, yCol, aggType) {
        aggType = (aggType || 'sum').toLowerCase();
        const buckets = {};
        if (!Array.isArray(items)) return {};
        for (const row of items) {
          const x = row && Object.prototype.hasOwnProperty.call(row, xCol) ? row[xCol] : '__undefined__';
          const xv = (x === null || x === undefined) ? '' : String(x);
          let y = row && Object.prototype.hasOwnProperty.call(row, yCol) ? row[yCol] : null;
          const yNum = (y === null || y === undefined || y === '') ? NaN : Number(String(y).replace(/[^0-9\.\-eE]/g,''));
          if (!buckets[xv]) buckets[xv] = { nums: [], raw: [] };
          if (!isNaN(yNum)) buckets[xv].nums.push(yNum);
          buckets[xv].raw.push(y);
        }
        const out = {};
        for (const [k, v] of Object.entries(buckets)) {
          const nums = v.nums;
          if (aggType === 'count') out[k] = v.raw.length;
          else if (aggType === 'avg') out[k] = nums.length ? nums.reduce((a,b)=>a+b,0)/nums.length : 0;
          else if (aggType === 'max') out[k] = nums.length ? Math.max(...nums) : 0;
          else if (aggType === 'min') out[k] = nums.length ? Math.min(...nums) : 0;
          else out[k] = nums.length ? nums.reduce((a,b)=>a+b,0) : 0;
        }
        console.info('[fallbacks] __aggregate fallback installed (aggType=' + aggType + ')');
        return out;
      };
    }
  })();
  </script>

  <script>
    // Variables de estado
    let currentData = [];
    let currentChart = null;
    let processedData = [];
    const STORAGE_KEY = 'dataviz-module-01';

    // --- (Funciones de carga/preview) ---
    function loadCSV(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        try {
          currentData = (typeof parseCSV === 'function') ? parseCSV(text) : [];
        } catch(err) { currentData = []; console.error('parseCSV error', err); }
        displayData();
        populateColumnSelects();
        if (typeof showNotification === 'function') showNotification('CSV cargado correctamente', 'success');
      };
      reader.readAsText(file);
    }

    function parseManualCSV() {
      const text = document.getElementById('csvTextInput').value.trim();
      if (!text) { if (typeof showNotification === 'function') showNotification('Por favor ingresa datos CSV', 'error'); return; }
      try {
        currentData = (typeof parseCSV === 'function') ? parseCSV(text) : [];
      } catch(err) { currentData = []; console.error('parseCSV error', err); }
      displayData();
      populateColumnSelects();
      if (typeof showNotification === 'function') showNotification('Datos cargados correctamente', 'success');
    }

    function displayData() {
      if (currentData.length === 0) return;
      const preview = document.getElementById('dataPreview');
      const table = document.getElementById('dataTable');
      const rowCount = document.getElementById('rowCount');
      preview.classList.remove('hidden');
      rowCount.textContent = currentData.length;
      const headers = Object.keys(currentData[0]);
      let html = '<thead><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      currentData.slice(0, 10).forEach(row => {
        html += '<tr>';
        headers.forEach(h => html += `<td>${row[h]}</td>`);
        html += '</tr>';
      });
      if (currentData.length > 10) {
        html += `<tr><td colspan="${headers.length}" style="text-align: center; font-style: italic;">... y ${currentData.length - 10} filas m√°s</td></tr>`;
      }
      html += '</tbody>';
      table.innerHTML = html;
    }

    function populateColumnSelects() {
      if (currentData.length === 0) return;
      const headers = Object.keys(currentData[0]);
      const xAxis = document.getElementById('xAxis');
      const yAxis = document.getElementById('yAxis');
      const groupBy = document.getElementById('groupBy');
      [xAxis, yAxis, groupBy].forEach(select => {
        const current = select.value;
        select.innerHTML = select.id === 'groupBy' ? '<option value="">Sin agrupaci√≥n</option>' : '<option value="">Selecciona columna...</option>';
        headers.forEach(h => {
          const option = document.createElement('option');
          option.value = h;
          option.textContent = h;
          select.appendChild(option);
        });
        if (current) select.value = current;
      });
    }

    // --- renderChart (con llamada segura a groupBy/aggregate) ---
    function renderChart() {
      const xCol = document.getElementById('xAxis').value;
      const yCol = document.getElementById('yAxis').value;
      const chartType = document.getElementById('chartType').value;
      const groupByCol = document.getElementById('groupBy').value;
      const aggType = document.getElementById('aggregation').value;
      const title = document.getElementById('chartTitle').value || 'Gr√°fico de Datos';

      if (!xCol || !yCol) { if (typeof showNotification === 'function') showNotification('Selecciona columnas para X e Y', 'error'); return; }
      if (currentData.length === 0) { if (typeof showNotification === 'function') showNotification('Primero carga un CSV', 'error'); return; }

      // obtain working functions: prefer repo-provided, otherwise use safe fallbacks
      const groupByFn = (typeof window.groupBy === 'function') ? window.groupBy : (typeof window.__groupBy === 'function' ? window.__groupBy : null);
      const aggregateFn = (typeof window.aggregate === 'function') ? window.aggregate : (typeof window.__aggregate === 'function' ? window.__aggregate : null);

      if (!aggregateFn) {
        console.error('aggregate function not available');
        if (typeof showNotification === 'function') showNotification('Funci√≥n aggregate no disponible', 'error');
        return;
      }

      let chartData;
      // Agrupado por categor√≠a
      if (groupByCol && groupByFn) {
        const grouped = groupByFn(currentData, groupByCol);
        const datasets = [];
        for (const [group, items] of Object.entries(grouped)) {
          const aggregated = aggregateFn(items, xCol, yCol, aggType);
          datasets.push({
            label: group,
            data: Object.values(aggregated),
            backgroundColor: `hsla(${Math.random() * 360}, 70%, 60%, 0.8)`,
            borderColor: `hsla(${Math.random() * 360}, 70%, 50%, 1)`,
            borderWidth: 2
          });
        }
        chartData = {
          labels: Object.keys(aggregateFn(currentData, xCol, yCol, aggType)),
          datasets: datasets
        };
      } else {
        const aggregated = aggregateFn(currentData, xCol, yCol, aggType);
        processedData = Object.entries(aggregated).map(([k, v]) => ({ [xCol]: k, [yCol]: v }));

        if (chartType === 'scatter') {
          const points = processedData.map(r => {
            const xRaw = r[xCol];
            const xNum = Number(String(xRaw).replace(/[^0-9\.\-]+/g,''));
            const yNum = Number(String(r[yCol]).replace(/[^0-9\.\-]+/g,'')) || 0;
            return { x: isNaN(xNum) ? null : xNum, y: isNaN(yNum) ? null : yNum };
          }).filter(p => p.x !== null && p.y !== null);

          if (points.length === 0) {
            if (typeof showNotification === 'function') showNotification('Scatter requiere valores num√©ricos en el eje X; usa L√≠nea o Barras', 'error');
            return;
          }

          chartData = {
            datasets: [{
              label: yCol,
              data: points,
              backgroundColor: 'rgba(102, 126, 234, 0.8)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          };
        } else {
          chartData = {
            labels: Object.keys(aggregated),
            datasets: [{
              label: yCol,
              data: Object.values(aggregated),
              backgroundColor: 'rgba(102, 126, 234, 0.8)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          };
        }
      }

      if (currentChart) { currentChart.destroy(); currentChart = null; }

      const ctx = document.getElementById('myChart').getContext('2d');

      try {
        const cfg = {
          type: chartType === 'scatter' ? 'scatter' : chartType,
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: title, font: { size: 18 } },
              legend: { display: true }
            },
            scales: chartType !== 'pie' && chartType !== 'doughnut' ? { y: { beginAtZero: true } } : {}
          }
        };
        currentChart = new Chart(ctx, cfg);
        if (typeof showNotification === 'function') showNotification('Gr√°fico generado correctamente', 'success');
      } catch (err) {
        console.error('Error creando chart:', err);
        if (typeof showNotification === 'function') showNotification('Error al generar el gr√°fico (ver consola)', 'error');
      }
    }

    // resto de utilidades...
    function clearChart() { if (currentChart) { currentChart.destroy(); currentChart = null; if (typeof showNotification === 'function') showNotification('Gr√°fico limpiado', 'info'); } }
    function downloadChart() {
      if (!currentChart) { if (typeof showNotification === 'function') showNotification('Primero genera un gr√°fico', 'error'); return; }
      const canvas = document.getElementById('myChart');
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url; link.download = `modulo-01-grafico-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
        link.click(); URL.revokeObjectURL(url);
        if (typeof showNotification === 'function') showNotification('Gr√°fico descargado', 'success');
      });
    }
    function downloadProcessedData() {
      if (processedData.length === 0 && currentData.length === 0) { if (typeof showNotification === 'function') showNotification('No hay datos para descargar', 'error'); return; }
      const dataToDownload = processedData.length > 0 ? processedData : currentData;
      const csv = arrayToCSV(dataToDownload);
      downloadFile(csv, `modulo-01-datos-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`, 'text/csv');
      if (typeof showNotification === 'function') showNotification('Datos descargados', 'success');
    }

    // minimal placeholders for quiz/save functions (kept short)
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: ['a', 'b', 'd'] };
    function evaluateQuiz() { /* same logic as earlier */ }
    function updateSavedDataInfo() { const results = loadFromLocalStorage(STORAGE_KEY); const content = document.getElementById('savedDataContent'); if (results) content.innerHTML = `<p><strong>√öltima evaluaci√≥n:</strong> ${new Date(results.date).toLocaleString('es-ES')}</p><p><strong>Puntuaci√≥n:</strong> ${results.score}%</p><p><strong>M√≥dulo:</strong> ${results.module}</p>`; else content.textContent = 'No hay datos guardados a√∫n.'; }

    window.addEventListener('load', () => {
      console.log('Verificando helpers:', typeof parseCSV, typeof aggregate, typeof showNotification);
      if (typeof parseCSV !== 'function' || (typeof aggregate !== 'function' && typeof window.__aggregate !== 'function')) {
        if (typeof showNotification === 'function') showNotification('Advertencia: helpers no cargados (utils.js). Comprueba la consola y la red.', 'error');
        else console.warn('Advertencia: helpers no cargados (utils.js). Comprueba la consola y la red.');
      }
      updateSavedDataInfo();
    });
  </script>

  <!-- HOTFIX2: robust file input + drag&drop + delimiter-tolerant CSV parser (no auto-open) -->
  <script>
  (function(){
    console.debug('[HOTFIX2] start');

    let fi = document.getElementById('fileInput');
    if (!fi) {
      fi = document.createElement('input');
      fi.type = 'file'; fi.id = 'fileInput'; fi.accept = '.csv,text/csv';
      document.body.appendChild(fi);
      console.debug('[HOTFIX2] created #fileInput at end of body');
    }

    const drop = document.querySelector('.file-upload-area');
    if (drop) {
      drop.style.position = drop.style.position || 'relative';
      if (!drop.querySelector('#fileInput')) drop.appendChild(fi);
      fi.style.position = 'relative'; fi.style.display = 'inline-block'; fi.style.opacity = 1; fi.style.zIndex = 9999; fi.style.width = '1px'; fi.style.height = '1px';
      drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList && drop.classList.add('dragover'); });
      drop.addEventListener('dragleave', e => { e.preventDefault(); drop.classList && drop.classList.remove('dragover'); });
      drop.addEventListener('drop', e => {
        e.preventDefault();
        drop.classList && drop.classList.remove('dragover');
        const files = e.dataTransfer && e.dataTransfer.files;
        if (files && files.length) handleFiles(files);
      });
    } else {
      fi.style.position = 'fixed'; fi.style.right = '20px'; fi.style.top = '80px'; fi.style.display = 'inline-block'; fi.style.zIndex = 9999; fi.style.opacity = 1;
    }

    function handleFiles(files) {
      if (!files || files.length === 0) { console.debug('[HOTFIX2] no files provided'); return; }
      const file = files[0]; console.debug('[HOTFIX2] file selected:', file.name, file.size); readFile(file);
    }

    function autoParseCSV(text) {
      if (!text) return [];
      const sample = text.slice(0, 2000);
      const counts = { ',': (sample.match(/,/g)||[]).length, ';': (sample.match(/;/g)||[]).length, '\\t': (sample.match(/\\t/g)||[]).length };
      let delim = ',';
      if (counts[';'] > counts[','] && counts[';'] >= counts['\\t']) delim=';';
      else if (counts['\\t'] > counts[','] && counts['\\t'] >= counts[';']) delim='\\t';
      const lines = String(text).trim().split(/\\r?\\n/).filter(l=>l.trim().length>0);
      if (lines.length === 0) return [];
      const headers = lines.shift().split(delim).map(h=>h.trim());
      return lines.map(l => { const cols = l.split(delim); const obj = {}; for (let i=0;i<headers.length;i++) obj[headers[i]] = (cols[i]||'').trim(); return obj; });
    }

    function readFile(file) {
      if (!file) return;
      if (typeof FileReader === 'undefined') { console.error('[HOTFIX2] FileReader not supported'); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const parseFn = (typeof parseCSV === 'function') ? parseCSV : autoParseCSV;
        let data;
        try { data = parseFn(text); } catch(err) { console.error('[HOTFIX2] parse error', err); if (typeof showNotification === 'function') showNotification('Error parsing CSV', 'error'); return; }
        console.debug('[HOTFIX2] parsed rows:', Array.isArray(data) ? data.length : '(unknown)');
        window.currentData = data;
        if (typeof displayData === 'function') { try { displayData(); console.debug('[HOTFIX2] displayData() invoked'); } catch(e){ console.error('[HOTFIX2] displayData() error', e); } }
        if (typeof populateColumnSelects === 'function') { try { populateColumnSelects(); console.debug('[HOTFIX2] populateColumnSelects() invoked'); } catch(e){ console.error('[HOTFIX2] populateColumnSelects() error', e); } }
        if (typeof showNotification === 'function') showNotification('CSV cargado correctamente', 'success');
      };
      reader.onerror = function(err) { console.error('[HOTFIX2] FileReader error', err); if (typeof showNotification === 'function') showNotification('Error leyendo archivo', 'error'); };
      reader.readAsText(file, 'UTF-8');
    }

    fi.addEventListener('change', e => handleFiles(e.target.files));
    window.__hotfix2 = { autoParseCSV, handleFiles };
    console.debug('[HOTFIX2] ready (user must click area or drop file)');
  })();
  </script>

</body>
</html>
