<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Introducci√≥n a Data Visualization - DataViz-Storytelling</title>

    <!-- styles: usamos CDN para que funcione en htmlpreview/jsDelivr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/angra8410/all-my-learnings@main/DataViz-Storytelling/examples/styles.css">

    <!-- Chart & Plotly CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js"></script>

    <style>
      /* Aseguramos tama√±o visible del canvas */
      .chart-container{ position: relative; height: 420px; margin-bottom: 12px; }
      .chart-canvas{ width:100% !important; height:100% !important; display:block; }
      /* Peque√±as mejoras visuales para htmlpreview */
      .hidden{ display:none; }
    </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä M√≥dulo 01: Introducci√≥n a Data Visualization</h1>
      <p>Ejercicio Interactivo - DataViz-Storytelling</p>
    </div>

    <div class="content">
      <div class="alert alert-info">
        <strong>Instrucciones:</strong> Carga un CSV, configura el gr√°fico y responde el cuestionario.
      </div>

      <!-- Paso 1: Cargar datos -->
      <div class="section">
        <h2>üìÅ Paso 1: Cargar Datos</h2>
        <div class="form-group">
          <label>Cargar archivo CSV:</label>
          <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".csv" onchange="loadCSV(event)">
            <p>üìÇ Click aqu√≠ para seleccionar un archivo CSV</p>
            <p style="font-size: 0.9em; opacity: 0.7;">O usa los archivos de ejemplo en /examples/</p>
          </div>
        </div>
        <div class="form-group">
          <label>O pega datos CSV:</label>
          <textarea id="csvTextInput" placeholder="Mes,Producto,Ventas&#10;Enero,A,150&#10;Febrero,A,180"></textarea>
          <button class="btn btn-secondary" onclick="parseManualCSV()">Cargar datos pegados</button>
        </div>

        <div id="dataPreview" class="hidden">
          <h3>Vista previa de datos:</h3>
          <div style="overflow-x: auto;">
            <table class="data-table" id="dataTable"></table>
          </div>
          <p><strong>Filas cargadas:</strong> <span id="rowCount">0</span></p>
        </div>
      </div>

      <!-- Paso 2: Configurar gr√°fico -->
      <div class="section">
        <h2>‚öôÔ∏è Paso 2: Configurar Gr√°fico</h2>
        <div class="form-group">
          <label for="chartType">Tipo de gr√°fico:</label>
          <select id="chartType">
            <option value="bar">Barras</option>
            <option value="line">L√≠neas</option>
            <option value="scatter">Dispersi√≥n (Scatter)</option>
            <option value="pie">Circular (Pie)</option>
            <option value="doughnut">Dona (Doughnut)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="xAxis">Eje X (etiquetas):</label>
          <select id="xAxis"><option value="">Selecciona columna...</option></select>
        </div>
        <div class="form-group">
          <label for="yAxis">Eje Y (valores):</label>
          <select id="yAxis"><option value="">Selecciona columna...</option></select>
        </div>
        <div class="form-group">
          <label for="groupBy">Agrupar por (opcional):</label>
          <select id="groupBy"><option value="">Sin agrupaci√≥n</option></select>
        </div>
        <div class="form-group">
          <label for="aggregation">Operaci√≥n de agregaci√≥n:</label>
          <select id="aggregation">
            <option value="sum">Suma</option><option value="avg">Promedio</option>
            <option value="count">Conteo</option><option value="max">M√°ximo</option>
            <option value="min">M√≠nimo</option>
          </select>
        </div>
        <div class="form-group">
          <label for="chartTitle">T√≠tulo del gr√°fico:</label>
          <input type="text" id="chartTitle" placeholder="Mi Gr√°fico de Datos">
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="renderChart()">Generar Gr√°fico</button>
          <button class="btn btn-secondary" onclick="clearChart()">Limpiar</button>
        </div>
      </div>

      <!-- Paso 3: Visualizaci√≥n -->
      <div class="section">
        <h2>üìä Paso 3: Visualizaci√≥n</h2>
        <div class="chart-container">
          <canvas id="myChart" class="chart-canvas"></canvas>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="downloadChart()">Descargar Gr√°fico PNG</button>
          <button class="btn btn-secondary" onclick="downloadProcessedData()">Descargar Datos Procesados CSV</button>
        </div>
      </div>

      <!-- Paso 4: Cuestionario -->
      <div class="section">
        <h2>‚úÖ Paso 4: Cuestionario del M√≥dulo</h2>
        <form id="quizForm">
          <!-- preguntas... (id√©nticas a las tuyas) -->
          <div class="quiz-question">
            <div class="question-number">Pregunta 1 de 4</div>
            <div class="question-text">¬øCu√°l es el prop√≥sito principal de la visualizaci√≥n de datos?</div>
            <div class="quiz-options">
              <div class="quiz-option"><input type="radio" name="q1" value="a" id="q1a"><label for="q1a">Decorar informes</label></div>
              <div class="quiz-option"><input type="radio" name="q1" value="b" id="q1b"><label for="q1b">Comunicar informaci√≥n de forma efectiva</label></div>
              <div class="quiz-option"><input type="radio" name="q1" value="c" id="q1c"><label for="q1c">Ocultar datos complejos</label></div>
            </div>
          </div>
          
          <div class="quiz-question">
            <div class="question-number">Pregunta 2 de 4</div>
            <div class="question-text">¬øCu√°l de los siguientes NO es un tipo com√∫n de gr√°fico?</div>
            <div class="quiz-options">
              <div class="quiz-option"><input type="radio" name="q2" value="a" id="q2a"><label for="q2a">Gr√°fico de barras</label></div>
              <div class="quiz-option"><input type="radio" name="q2" value="b" id="q2b"><label for="q2b">Gr√°fico de arco iris</label></div>
              <div class="quiz-option"><input type="radio" name="q2" value="c" id="q2c"><label for="q2c">Gr√°fico de l√≠neas</label></div>
            </div>
          </div>
          
          <div class="quiz-question">
            <div class="question-number">Pregunta 3 de 4</div>
            <div class="question-text">¬øQu√© biblioteca JavaScript se utiliza en este ejercicio para crear gr√°ficos?</div>
            <div class="quiz-options">
              <div class="quiz-option"><input type="radio" name="q3" value="a" id="q3a"><label for="q3a">D3.js</label></div>
              <div class="quiz-option"><input type="radio" name="q3" value="b" id="q3b"><label for="q3b">Chart.js</label></div>
              <div class="quiz-option"><input type="radio" name="q3" value="c" id="q3c"><label for="q3c">Matplotlib</label></div>
            </div>
          </div>
          
          <div class="quiz-question">
            <div class="question-number">Pregunta 4 de 4</div>
            <div class="question-text">Selecciona las mejores pr√°cticas en visualizaci√≥n de datos: (selecciona todas las correctas)</div>
            <div class="quiz-options">
              <div class="quiz-option"><input type="checkbox" name="q4" value="a" id="q4a"><label for="q4a">Usar colores apropiados y accesibles</label></div>
              <div class="quiz-option"><input type="checkbox" name="q4" value="b" id="q4b"><label for="q4b">Incluir t√≠tulos y etiquetas claras</label></div>
              <div class="quiz-option"><input type="checkbox" name="q4" value="c" id="q4c"><label for="q4c">Usar tantos efectos 3D como sea posible</label></div>
              <div class="quiz-option"><input type="checkbox" name="q4" value="d" id="q4d"><label for="q4d">Mantener la simplicidad y claridad</label></div>
            </div>
          </div>
          
          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="evaluateQuiz()">Evaluar</button>
            <button type="button" class="btn btn-secondary" onclick="resetQuiz()">Reiniciar</button>
          </div>
        </form>

        <div id="quizResults" class="results hidden">
          <h3>Resultados del Cuestionario</h3>
          <div class="score" id="quizScore">0%</div>
          <p id="quizFeedback"></p>
        </div>
      </div>

      <!-- Paso 5: Guardar y exportar -->
      <div class="section">
        <h2>üíæ Paso 5: Guardar y Exportar</h2>
        <div class="btn-group">
          <button class="btn btn-success" onclick="downloadAllResults()">Descargar Todos los Resultados JSON</button>
          <button class="btn btn-secondary" onclick="clearSavedData()">Limpiar Datos Guardados</button>
        </div>
        <div id="savedDataInfo" class="card">
          <div class="card-header">Informaci√≥n de Guardado</div>
          <div class="card-body" id="savedDataContent">No hay datos guardados a√∫n.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- utils.js desde jsDelivr (apunta a tu repo/branch) -->
  <script src="https://cdn.jsdelivr.net/gh/angra8410/all-my-learnings@main/DataViz-Storytelling/examples/utils.js"></script>

  <script>
    // Variables de estado
    let currentData = [];
    let currentChart = null;
    let processedData = [];
    const STORAGE_KEY = 'dataviz-module-01';

    // --- Fallback functions if utils.js fails to load from CDN ---
    if (typeof parseCSV !== 'function') {
      function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = values[index];
          });
          return obj;
        });
      }
    }

    if (typeof arrayToCSV !== 'function') {
      function arrayToCSV(data) {
        if (!data || data.length === 0) return '';
        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(',')];
        for (const row of data) {
          const values = headers.map(header => {
            const val = row[header];
            return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
          });
          csvRows.push(values.join(','));
        }
        return csvRows.join('\n');
      }
    }

    if (typeof downloadFile !== 'function') {
      function downloadFile(content, filename, contentType = 'text/plain') {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
      }
    }

    if (typeof saveToLocalStorage !== 'function') {
      function saveToLocalStorage(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
          return true;
        } catch (e) {
          console.error('Error saving to localStorage:', e);
          return false;
        }
      }
    }

    if (typeof loadFromLocalStorage !== 'function') {
      function loadFromLocalStorage(key) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error('Error loading from localStorage:', e);
          return null;
        }
      }
    }

    if (typeof formatDate !== 'function') {
      function formatDate(date = new Date()) {
        return date.toISOString().split('T')[0];
      }
    }

    if (typeof groupBy !== 'function') {
      function groupBy(array, key) {
        return array.reduce((result, item) => {
          (result[item[key]] = result[item[key]] || []).push(item);
          return result;
        }, {});
      }
    }

    if (typeof aggregate !== 'function') {
      function aggregate(array, groupKey, valueKey, operation = 'sum') {
        const grouped = groupBy(array, groupKey);
        const result = {};
        for (const [group, items] of Object.entries(grouped)) {
          const values = items.map(item => parseFloat(item[valueKey]) || 0);
          switch (operation) {
            case 'sum':
              result[group] = values.reduce((a, b) => a + b, 0);
              break;
            case 'avg':
              result[group] = values.reduce((a, b) => a + b, 0) / values.length;
              break;
            case 'count':
              result[group] = values.length;
              break;
            case 'max':
              result[group] = Math.max(...values);
              break;
            case 'min':
              result[group] = Math.min(...values);
              break;
          }
        }
        return result;
      }
    }

    if (typeof showNotification !== 'function') {
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 25px;
          background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }
      
      // Add CSS animations if not already added
      if (!document.getElementById('notification-animations')) {
        const style = document.createElement('style');
        style.id = 'notification-animations';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
    }

    // --- (Funciones de carga/preview con manejo robusto de errores) ---
    function loadCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.name.endsWith('.csv')) {
        showNotification('Por favor selecciona un archivo CSV v√°lido', 'error');
        return;
      }
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showNotification('El archivo es demasiado grande. M√°ximo 5MB', 'error');
        return;
      }
      
      const reader = new FileReader();
      
      reader.onerror = function() {
        showNotification('Error al leer el archivo. Intenta de nuevo', 'error');
        console.error('FileReader error:', reader.error);
      };
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          if (!text || text.trim().length === 0) {
            showNotification('El archivo est√° vac√≠o', 'error');
            return;
          }
          
          currentData = parseCSV(text);
          
          if (!currentData || currentData.length === 0) {
            showNotification('No se pudieron extraer datos del CSV', 'error');
            return;
          }
          
          displayData();
          populateColumnSelects();
          showNotification('CSV cargado correctamente', 'success');
        } catch (error) {
          showNotification('Error al procesar el CSV: ' + error.message, 'error');
          console.error('CSV parsing error:', error);
        }
      };
      
      reader.readAsText(file);
    }

    function parseManualCSV() {
      const text = document.getElementById('csvTextInput').value.trim();
      if (!text) { 
        showNotification('Por favor ingresa datos CSV', 'error'); 
        return; 
      }
      
      try {
        currentData = parseCSV(text);
        
        if (!currentData || currentData.length === 0) {
          showNotification('No se pudieron extraer datos del CSV', 'error');
          return;
        }
        
        displayData();
        populateColumnSelects();
        showNotification('Datos cargados correctamente', 'success');
      } catch (error) {
        showNotification('Error al procesar el CSV: ' + error.message, 'error');
        console.error('CSV parsing error:', error);
      }
    }

    function displayData() {
      if (currentData.length === 0) return;
      const preview = document.getElementById('dataPreview');
      const table = document.getElementById('dataTable');
      const rowCount = document.getElementById('rowCount');
      preview.classList.remove('hidden');
      rowCount.textContent = currentData.length;
      const headers = Object.keys(currentData[0]);
      let html = '<thead><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      currentData.slice(0, 10).forEach(row => {
        html += '<tr>';
        headers.forEach(h => html += `<td>${row[h]}</td>`);
        html += '</tr>';
      });
      if (currentData.length > 10) {
        html += `<tr><td colspan="${headers.length}" style="text-align: center; font-style: italic;">... y ${currentData.length - 10} filas m√°s</td></tr>`;
      }
      html += '</tbody>';
      table.innerHTML = html;
    }

    function populateColumnSelects() {
      if (currentData.length === 0) return;
      const headers = Object.keys(currentData[0]);
      const xAxis = document.getElementById('xAxis');
      const yAxis = document.getElementById('yAxis');
      const groupBy = document.getElementById('groupBy');
      [xAxis, yAxis, groupBy].forEach(select => {
        const current = select.value;
        select.innerHTML = select.id === 'groupBy' ? '<option value="">Sin agrupaci√≥n</option>' : '<option value="">Selecciona columna...</option>';
        headers.forEach(h => {
          const option = document.createElement('option');
          option.value = h;
          option.textContent = h;
          select.appendChild(option);
        });
        if (current) select.value = current;
      });
    }

    // --- Funci√≥n principal renderChart con soporte scatter robusto ---
    function renderChart() {
      const xCol = document.getElementById('xAxis').value;
      const yCol = document.getElementById('yAxis').value;
      const chartType = document.getElementById('chartType').value;
      const groupByCol = document.getElementById('groupBy').value;
      const aggType = document.getElementById('aggregation').value;
      const title = document.getElementById('chartTitle').value || 'Gr√°fico de Datos';

      if (!xCol || !yCol) { showNotification('Selecciona columnas para X e Y', 'error'); return; }
      if (currentData.length === 0) { showNotification('Primero carga un CSV', 'error'); return; }

      let chartData;
      // Agrupado por categor√≠a
      if (groupByCol) {
        const grouped = groupBy(currentData, groupByCol);
        const datasets = [];
        for (const [group, items] of Object.entries(grouped)) {
          const aggregated = aggregate(items, xCol, yCol, aggType);
          datasets.push({
            label: group,
            data: Object.values(aggregated),
            backgroundColor: `hsla(${Math.random() * 360}, 70%, 60%, 0.8)`,
            borderColor: `hsla(${Math.random() * 360}, 70%, 50%, 1)`,
            borderWidth: 2
          });
        }
        chartData = {
          labels: Object.keys(aggregate(currentData, xCol, yCol, aggType)),
          datasets: datasets
        };
      } else {
        const aggregated = aggregate(currentData, xCol, yCol, aggType);
        processedData = Object.entries(aggregated).map(([k, v]) => ({ [xCol]: k, [yCol]: v }));

        // Si es scatter necesitamos valores num√©ricos en X e Y
        if (chartType === 'scatter') {
          const points = processedData.map(r => {
            const xRaw = r[xCol];
            const xNum = Number(String(xRaw).replace(/[^0-9\.\-]+/g,'')); // intenta extraer n√∫mero
            const yNum = Number(String(r[yCol]).replace(/[^0-9\.\-]+/g,'')) || 0;
            return { x: isNaN(xNum) ? null : xNum, y: isNaN(yNum) ? null : yNum };
          }).filter(p => p.x !== null && p.y !== null);

          if (points.length === 0) {
            showNotification('Scatter requiere valores num√©ricos en el eje X; usa L√≠nea o Barras', 'error');
            return;
          }

          chartData = {
            datasets: [{
              label: yCol,
              data: points,
              backgroundColor: 'rgba(102, 126, 234, 0.8)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          };
        } else {
          chartData = {
            labels: Object.keys(aggregated),
            datasets: [{
              label: yCol,
              data: Object.values(aggregated),
              backgroundColor: 'rgba(102, 126, 234, 0.8)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          };
        }
      }

      // Destroy previous chart
      if (currentChart) { currentChart.destroy(); currentChart = null; }

      // Create chart depending on type
      const ctx = document.getElementById('myChart').getContext('2d');

      try {
        const cfg = {
          type: chartType === 'scatter' ? 'scatter' : chartType,
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: title, font: { size: 18 } },
              legend: { display: true }
            },
            scales: chartType !== 'pie' && chartType !== 'doughnut' ? { y: { beginAtZero: true } } : {}
          }
        };
        currentChart = new Chart(ctx, cfg);
        showNotification('Gr√°fico generado correctamente', 'success');
      } catch (err) {
        console.error('Error creando chart:', err);
        showNotification('Error al generar el gr√°fico (ver consola)', 'error');
      }
    }

    function clearChart() {
      if (currentChart) { currentChart.destroy(); currentChart = null; showNotification('Gr√°fico limpiado', 'info'); }
    }

    function downloadChart() {
      if (!currentChart) { showNotification('Primero genera un gr√°fico', 'error'); return; }
      const canvas = document.getElementById('myChart');
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url; link.download = `modulo-01-grafico-${formatDate()}.png`;
        link.click(); URL.revokeObjectURL(url);
        showNotification('Gr√°fico descargado', 'success');
      });
    }

    function downloadProcessedData() {
      if (processedData.length === 0 && currentData.length === 0) { showNotification('No hay datos para descargar', 'error'); return; }
      const dataToDownload = processedData.length > 0 ? processedData : currentData;
      const csv = arrayToCSV(dataToDownload);
      downloadFile(csv, `modulo-01-datos-${formatDate()}.csv`, 'text/csv');
      showNotification('Datos descargados', 'success');
    }

    // --- Quiz (id√©ntico al tuyo) ---
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: ['a', 'b', 'd'] };

    function evaluateQuiz() {
      let correct = 0; const total = Object.keys(correctAnswers).length;
      const userAnswers = {};
      for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
        const inputs = document.querySelectorAll(`input[name="${question}"]`);
        if (Array.isArray(correctAnswer)) {
          userAnswers[question] = Array.from(inputs).filter(i=>i.checked).map(i=>i.value).sort();
          if (JSON.stringify(userAnswers[question]) === JSON.stringify(correctAnswer.sort())) correct++;
        } else {
          const checked = Array.from(inputs).find(i=>i.checked);
          userAnswers[question] = checked ? checked.value : null;
          if (userAnswers[question] === correctAnswer) correct++;
        }
      }
      const score = Math.round((correct / total) * 100);
      displayQuizResults(score); saveResults(score, userAnswers);
    }

    function displayQuizResults(score) {
      const resultsDiv = document.getElementById('quizResults');
      const scoreDiv = document.getElementById('quizScore');
      const feedbackDiv = document.getElementById('quizFeedback');
      resultsDiv.classList.remove('hidden'); scoreDiv.textContent = `${score}%`; scoreDiv.className = 'score';
      if (score >= 70) { scoreDiv.classList.add('high'); resultsDiv.classList.remove('error'); feedbackDiv.textContent = '¬°Excelente!'; }
      else if (score >= 50) { scoreDiv.classList.add('medium'); resultsDiv.classList.remove('error'); feedbackDiv.textContent = 'Buen trabajo.'; }
      else { scoreDiv.classList.add('low'); resultsDiv.classList.add('error'); feedbackDiv.textContent = 'Revisa el material.'; }
      showNotification(`Puntuaci√≥n: ${score}%`, score >= 70 ? 'success' : 'info');
    }

    function resetQuiz() { document.getElementById('quizForm').reset(); document.getElementById('quizResults').classList.add('hidden'); showNotification('Cuestionario reiniciado', 'info'); }

    function saveResults(score, answers) {
      const results = { date: new Date().toISOString(), score: score, answers: answers, module: '01' };
      saveToLocalStorage(STORAGE_KEY, results); updateSavedDataInfo();
    }

    function downloadAllResults() {
      const results = loadFromLocalStorage(STORAGE_KEY);
      if (!results) { showNotification('No hay resultados guardados', 'error'); return; }
      downloadFile(JSON.stringify(results, null, 2), `modulo-01-resultados-${formatDate()}.json`, 'application/json');
      showNotification('Resultados descargados', 'success');
    }

    function clearSavedData() { if (confirm('¬øSeguro que quieres borrar los datos guardados?')) { localStorage.removeItem(STORAGE_KEY); updateSavedDataInfo(); showNotification('Datos borrados', 'info'); } }

    function updateSavedDataInfo() {
      const results = loadFromLocalStorage(STORAGE_KEY);
      const content = document.getElementById('savedDataContent');
      if (results) {
        content.innerHTML = `<p><strong>√öltima evaluaci√≥n:</strong> ${new Date(results.date).toLocaleString('es-ES')}</p><p><strong>Puntuaci√≥n:</strong> ${results.score}%</p><p><strong>M√≥dulo:</strong> ${results.module}</p>`;
      } else { content.textContent = 'No hay datos guardados a√∫n.'; }
    }

    // Init
    window.addEventListener('load', () => {
      // Comprobaci√≥n: utils.js (CDN) debe haber definido las funciones helper
      const cdnLoaded = typeof parseCSV === 'function' && 
                       typeof aggregate === 'function' && 
                       typeof showNotification === 'function';
      
      console.log('Verificando helpers:', typeof parseCSV, typeof aggregate, typeof showNotification);
      
      if (!cdnLoaded) {
        console.warn('utils.js no se carg√≥ desde CDN. Usando funciones fallback inline.');
        // Show a subtle notification that we're using fallback
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 20px;
          padding: 10px 15px;
          background: #ff9800;
          color: white;
          border-radius: 6px;
          font-size: 0.85em;
          z-index: 9999;
        `;
        notification.textContent = '‚ö†Ô∏è Modo offline: usando funciones locales';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
      } else {
        console.log('‚úÖ utils.js cargado correctamente desde CDN');
      }
      
      updateSavedDataInfo();
    });
  </script>
</body>
</html>
