name: Data-AI-Course CI

on:
  push:
    branches: [ main, develop, "copilot/*" ]
    paths:
      - 'Data-AI-Course/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'Data-AI-Course/**'

jobs:
  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Course Structure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Validate week directories
      run: |
        cd Data-AI-Course
        
        echo "Checking for all required week directories..."
        for i in $(seq -f "%02g" 0 16); do
          week_dir=$(ls -d week-${i}-* 2>/dev/null | head -1)
          if [ -z "$week_dir" ]; then
            echo "‚ùå Missing week-${i}"
            exit 1
          else
            echo "‚úì Found $week_dir"
          fi
        done
        
        echo "‚úÖ All week directories present"
    
    - name: Validate required files
      run: |
        cd Data-AI-Course
        
        echo "Checking for required files in each week..."
        required_files=("README.md" "actividad-interactiva.md" "project-steps.md" "progreso.md" "retroalimentacion.md" "resources.md")
        
        for week in week-*/; do
          echo "Checking $week..."
          for file in "${required_files[@]}"; do
            if [ ! -f "$week/$file" ]; then
              echo "‚ùå Missing $week/$file"
              exit 1
            fi
          done
          echo "  ‚úì All required files present"
        done
        
        echo "‚úÖ All required files present in all weeks"
    
    - name: Check file sizes
      run: |
        cd Data-AI-Course
        
        echo "Checking that files are not empty..."
        find week-*/ -name "*.md" -type f -size 0 | while read empty_file; do
          echo "‚ö†Ô∏è  Warning: Empty file detected: $empty_file"
        done
        
        # Count non-empty markdown files
        total_md=$(find week-*/ -name "*.md" -type f | wc -l)
        non_empty=$(find week-*/ -name "*.md" -type f -size +100c | wc -l)
        
        echo "Total markdown files: $total_md"
        echo "Non-empty files (>100 bytes): $non_empty"
        
        if [ $non_empty -lt 85 ]; then
          echo "‚ùå Too many empty or small files"
          exit 1
        fi
        
        echo "‚úÖ File size check passed"
    
    - name: Validate examples directory
      run: |
        cd Data-AI-Course
        
        echo "Checking for examples directories..."
        for week in week-*/; do
          if [ ! -d "$week/examples" ]; then
            echo "‚ö†Ô∏è  Missing examples directory in $week"
          fi
        done
        
        echo "‚úÖ Examples directory check complete"

  lint-python:
    runs-on: ubuntu-latest
    name: Lint Python Code
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black
    
    - name: Check with flake8
      run: |
        cd Data-AI-Course
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,env
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,env
    
    - name: Check formatting with black
      run: |
        cd Data-AI-Course
        black --check --diff . --exclude="venv|env" || echo "‚ö†Ô∏è  Some files need formatting"

  test-setup-examples:
    runs-on: ubuntu-latest
    name: Test Setup Examples
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd Data-AI-Course
        if [ -f requirements.txt ]; then
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        fi
    
    - name: Validate Python syntax
      run: |
        cd Data-AI-Course
        echo "Checking Python syntax in example files..."
        find week-*/examples -name "*.py" -type f | while read py_file; do
          echo "Checking $py_file..."
          python -m py_compile "$py_file" || {
            echo "‚ùå Syntax error in $py_file"
            exit 1
          }
        done
        echo "‚úÖ All Python files have valid syntax"
    
    - name: Check imports (no API calls)
      run: |
        cd Data-AI-Course
        echo "Testing that example files can be imported..."
        # This checks imports work without running main code
        find week-00-setup-tools/examples -name "*.py" -type f | while read py_file; do
          echo "Import check: $py_file"
          # Simple import check without executing
          python -c "import ast; ast.parse(open('$py_file').read())" || {
            echo "‚ùå AST parse error in $py_file"
            exit 1
          }
        done
        echo "‚úÖ Import checks passed"

  validate-markdown:
    runs-on: ubuntu-latest
    name: Validate Markdown
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check markdown links (basic)
      run: |
        cd Data-AI-Course
        echo "Checking for broken markdown syntax..."
        
        # Check for common markdown issues
        find week-*/ -name "*.md" -type f | while read md_file; do
          # Check for unclosed code blocks
          if [ $(grep -c '```' "$md_file") -ne $(expr $(grep -c '```' "$md_file") / 2 \* 2) ]; then
            echo "‚ö†Ô∏è  Possible unclosed code block in $md_file"
          fi
        done
        
        echo "‚úÖ Markdown validation complete"
    
    - name: Validate course structure documentation
      run: |
        cd Data-AI-Course
        
        # Check that main README exists
        if [ ! -f README.md ]; then
          echo "‚ùå Missing main README.md"
          exit 1
        fi
        
        # Check for instructor notes
        if [ ! -f instructor-notes.md ]; then
          echo "‚ùå Missing instructor-notes.md"
          exit 1
        fi
        
        # Check for requirements.txt
        if [ ! -f requirements.txt ]; then
          echo "‚ùå Missing requirements.txt"
          exit 1
        fi
        
        # Check for .env.example
        if [ ! -f .env.example ]; then
          echo "‚ùå Missing .env.example"
          exit 1
        fi
        
        echo "‚úÖ Core documentation files present"

  check-security:
    runs-on: ubuntu-latest
    name: Security Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check for secrets in code
      run: |
        cd Data-AI-Course
        
        echo "Checking for potential secrets..."
        
        # Check for API keys
        if grep -r "sk-[a-zA-Z0-9]\{20,\}" week-*/examples --include="*.py" --include="*.md"; then
          echo "‚ùå Potential OpenAI API key found!"
          exit 1
        fi
        
        # Check for hard-coded credentials
        if grep -ri "password.*=.*['\"]" week-*/examples --include="*.py" | grep -v "YOUR_PASSWORD" | grep -v "<"; then
          echo "‚ùå Potential hard-coded password found!"
          exit 1
        fi
        
        echo "‚úÖ No obvious secrets detected"
    
    - name: Verify placeholder usage
      run: |
        cd Data-AI-Course
        
        echo "Verifying placeholders are used..."
        
        # Count placeholder usage
        placeholder_count=$(grep -r "<YOUR_" week-*/ --include="*.md" --include="*.py" | wc -l)
        
        echo "Found $placeholder_count placeholder instances"
        
        if [ $placeholder_count -lt 10 ]; then
          echo "‚ö†Ô∏è  Warning: Low placeholder count. Ensure secrets are parameterized."
        fi
        
        echo "‚úÖ Placeholder check complete"

  summary:
    runs-on: ubuntu-latest
    name: Validation Summary
    needs: [validate-structure, lint-python, test-setup-examples, validate-markdown, check-security]
    
    steps:
    - name: Summary
      run: |
        echo "======================================"
        echo "üìä CI Validation Summary"
        echo "======================================"
        echo "‚úÖ Course structure validated"
        echo "‚úÖ Python code linted"
        echo "‚úÖ Example code tested"
        echo "‚úÖ Markdown validated"
        echo "‚úÖ Security checks passed"
        echo "======================================"
        echo "üéâ All checks passed!"
        echo "======================================"
