<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PL-300: Microsoft Power BI Data Analyst — Curso interactivo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:14px">
        <!-- inline SVG icon to avoid external image 404 -->
        <svg width="44" height="44" viewBox="0 0 48 48" aria-hidden="true"><rect width="48" height="48" rx="8" fill="#F59E0B"></rect><path d="M12 30h6V18h-6v12zm10 0h6V14h-6v16zm10 0h6V22h-6v8z" fill="#fff"></path></svg>
        <div>
          <h1>PL-300: Microsoft Power BI Data Analyst — Curso interactivo (0 → Hero)</h1>
          <div style="opacity:.95">Lecciones, labs y quizzes. Usa el dataset de ejemplo para practicar.</div>
        </div>
      </div>
      <nav>
        <button id="tabOverview">Resumen</button>
        <button id="tabLessons">Lecciones</button>
        <button id="tabLab">Laboratorios</button>
        <button id="tabQuiz">Cuestionario</button>
        <button id="tabProgress">Progreso</button>
      </nav>
    </header>

    <main>
      <section id="contentArea">
        <div class="card" id="overviewCard">
          <div class="section-title"><h2>Course Overview</h2></div>
          <p class="muted">Este curso sigue la guía oficial del examen PL-300: Prepare, Model, Visualize, Manage. Usa el CSV de ejemplo en data/sales_sample.csv para los labs.</p>
          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div style="flex:1" class="card small">
              <div style="font-weight:700;font-size:18px">Total Lessons</div><div class="muted" id="totalLessons">—</div>
            </div>
            <div style="flex:1" class="card small">
              <div style="font-weight:700;font-size:18px">Completed</div><div class="muted" id="completedLessons">0</div>
            </div>
            <div style="flex:1" class="card small">
              <div style="font-weight:700;font-size:18px">Quiz Score</div><div class="muted" id="lastScore">-</div>
            </div>
            <div style="flex:1" class="card small">
              <div style="font-weight:700;font-size:18px">Progress</div><div class="muted" id="progressPct">0%</div>
            </div>
          </div>
        </div>

        <div id="lessonsArea" style="margin-top:18px" class="card">
          <h2>Lecciones del Curso</h2>
          <div id="lessonsGrid" class="grid-cards" style="margin-top:8px"></div>
        </div>

        <!-- lesson detail container injected or used by JS -->
        <div id="lessonDetail" style="margin-top:18px"></div>
      </section>

      <aside>
        <div class="card">
          <div class="section-title"><h3>TOC & Acciones</h3></div>
          <div style="margin-top:8px">
            <button id="exportBtn" class="primary">Exportar progreso</button>
            <button id="importBtn" style="margin-left:8px">Importar progreso</button>
            <div class="small" style="margin-top:8px">Dataset de ejemplo: <a id="csvLink" href="#" target="_blank">sales_sample.csv</a></div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
/*
  Defensive, self-contained script:
  - avoids external images/styles
  - ensures DOM nodes exist
  - uses RAW GitHub URL fallback for the CSV only if the file is not present relative
*/

(function(){
  // COURSE data (minimal example). In your repo this can be larger; here we ensure structure.
  const COURSE = {
    id: "pl300",
    title: "PL-300: Microsoft Power BI Data Analyst",
    modules: [
      { id: "m1", title: "Preparar los Datos", lessons: [
        { id: "m1-l1", title: "Obtener Datos desde Archivos y Excel", content: "<p>Aprende a conectar a archivos planos y Excel...</p>" },
        { id: "m1-l2", title: "Conectar a Bases de Datos SQL", content: "<p>Conectar a SQL Server y otras fuentes...</p>" },
        { id: "m1-l3", title: "Transformar Datos con Power Query", content: "<p>Usar Power Query para transformaciones...</p>" }
      ]},
      { id: "m2", title: "Modelar los Datos", lessons: [
        { id: "m2-l1", title: "Modelado Relacional y Normalización", content: "<p>Diseñar modelos y relaciones...</p>" },
        { id: "m2-l2", title: "DAX Básico", content: "<p>Funciones básicas de DAX...</p>" }
      ]},
      { id: "m3", title: "Visualizar & Analizar", lessons: [
        { id: "m3-l1", title: "Crear Informes", content: "<p>Diseño de reportes y mejores prácticas...</p>" }
      ]},
      { id: "m4", title: "Administrar & Asegurar", lessons: [
        { id: "m4-l1", title: "Workspaces y RLS", content: "<p>Seguridad y roles en Power BI...</p>" }
      ]}
    ]
  };

  // storage keys
  const STORAGE_KEY_PROGRESS = 'pl300-completed';
  const STORAGE_KEY_RESULTS = 'pl300-results';

  // helper: ensure nodes exist
  function ensureNode(selector, tag='div', attrs={}) {
    let el = document.querySelector(selector);
    if (!el) {
      el = document.createElement(tag);
      if (selector.startsWith('#')) el.id = selector.slice(1);
      document.querySelector('main')?.appendChild(el) || document.body.appendChild(el);
      for (const k in attrs) el.setAttribute(k, attrs[k]);
    }
    return el;
  }

  const lessonsGrid = ensureNode('#lessonsGrid');
  const lessonDetail = ensureNode('#lessonDetail');
  const csvLinkEl = document.getElementById('csvLink');

  // CSV link resolution: prefer relative path data/sales_sample.csv, fallback to raw github (when preview rewriting breaks)
  function resolveCsvUrl() {
    const relative = 'data/sales_sample.csv';
    // try to fetch relative (best-effort); if 404, use raw.githubusercontent fallback using repo info (owner/repo/main)
    const rawFallback = (function(){
      // replace OWNER/REPO with your repo if needed; this fallback is safe and will try to load if hosted on github
      return 'https://raw.githubusercontent.com/angra8410/all-my-learnings/main/Courses/PL-300-interactive-course/data/sales_sample.csv';
    })();
    return fetch(relative, { method: 'HEAD' }).then(res => {
      if (res.ok) return relative;
      return rawFallback;
    }).catch(()=> rawFallback);
  }

  resolveCsvUrl().then(url => {
    csvLinkEl.href = url;
    csvLinkEl.textContent = url.split('/').pop();
  });

  // render lessons grid
  function renderLessons() {
    lessonsGrid.innerHTML = '';
    let total = 0;
    COURSE.modules.forEach(mod => {
      const header = document.createElement('div');
      header.style.gridColumn = '1 / -1';
      header.innerHTML = `<div style="background:${getComputedStyle(document.documentElement).getPropertyValue('--primary')};color:#fff;padding:12px;border-radius:8px;margin-bottom:8px;font-weight:700">${mod.title}</div>`;
      lessonsGrid.appendChild(header);
      mod.lessons.forEach(lesson => {
        total++;
        const card = document.createElement('div');
        card.className = 'lesson-card';
        card.dataset.lessonId = lesson.id;
        card.innerHTML = `<h4 style="margin:0 0 6px 0">${lesson.title}</h4><div class="muted">${truncatePlainText(lesson.content || '', 80)}</div>`;
        card.addEventListener('click', ()=> openLesson(lesson));
        lessonsGrid.appendChild(card);
      });
    });
    document.getElementById('totalLessons').textContent = String(total);
    updateCompletedUI();
  }

  function truncatePlainText(html, len=80) {
    const t = (new DOMParser()).parseFromString(html, 'text/html').body.textContent || '';
    return t.length > len ? t.slice(0,len-1)+'…' : t;
  }

  // open a lesson and show detail
  function openLesson(lesson) {
    // create detail view if missing
    if (!document.getElementById('lessonView')) {
      const lv = document.createElement('div');
      lv.id = 'lessonView';
      lv.className = 'card';
      document.getElementById('lessonDetail').appendChild(lv);
    }
    const lv = document.getElementById('lessonView');
    lv.innerHTML = `<div class="section-title"><h3>${lesson.title}</h3><button id="markDone" class="primary">Marcar completada</button></div><div style="margin-top:12px">${lesson.content}</div>`;
    document.getElementById('markDone').addEventListener('click', ()=> {
      markCompleted(lesson.id);
      updateCompletedUI();
    });
  }

  // completed management
  function markCompleted(lessonId) {
    const done = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS)||'[]'));
    done.add(lessonId);
    localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(Array.from(done)));
  }

  function updateCompletedUI() {
    const done = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS)||'[]'));
    document.querySelectorAll('.lesson-card').forEach(card => {
      if (done.has(card.dataset.lessonId)) card.classList.add('completed');
      else card.classList.remove('completed');
    });
    document.getElementById('completedLessons').textContent = String(done.size);
    const total = Number(document.getElementById('totalLessons').textContent) || 0;
    const pct = total ? Math.round(done.size/total*100) : 0;
    document.getElementById('progressPct').textContent = pct + '%';
  }

  // export/import progress
  document.getElementById('exportBtn').addEventListener('click', ()=> {
    const data = {
      progress: JSON.parse(localStorage.getItem(STORAGE_KEY_PROGRESS)||'[]'),
      results: JSON.parse(localStorage.getItem(STORAGE_KEY_RESULTS)||'{}')
    };
    const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'pl300-progress.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  document.getElementById('importBtn').addEventListener('click', ()=> {
    const input = document.createElement('input'); input.type='file'; input.accept='application/json';
    input.addEventListener('change', (e)=> {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (obj.progress) localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(obj.progress));
          if (obj.results) localStorage.setItem(STORAGE_KEY_RESULTS, JSON.stringify(obj.results));
          updateCompletedUI();
          alert('Progreso importado');
        } catch(err){ alert('Import error: '+err.message) }
      };
      reader.readAsText(f);
    });
    input.click();
  });

  // init
  renderLessons();

  // expose for debugging
  window.COURSE = COURSE;
  window.openLesson = openLesson;
  window.markCompleted = markCompleted;

})();
  </script>
</body>
</html>
